# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2
jobs:
  build:
    branches:
     only:
       - master
       - devel
       - circle
       - /devel-.*/
       - /circle-.*/
       - /ci-.*/

    gpu:
      - image: ubuntu-1604:201903-01
    resource_class: 1gpu

    working_directory: ~/repo

    steps:
      - checkout

      - run: sudo apt-get update
      - run: sudo apt-get install graphviz

      # Download and cache dependencies
      - restore_cache:
          keys:
            - pip-cache

      - run:
          name: install python dependencies
          command: |
            python3 -m venv venv
            . venv/bin/activate
            pip install -U pip
            pip install pycuda
            pip install git+https://github.com/benureau/leabra.git@master
            pip install -e .[dev]
          environment:
            PIP_PROGRESS_BAR: 'off'

      - save_cache:
          paths:
            - ~/.cache/pip
          key: pip-cache

      # run tests!
      - run:
          name: run pytest
          command: |
            echo "#!/bin/sh" > venv/bin/xdg-open
            chmod +x venv/bin/xdg-open
            . venv/bin/activate
            python -m pytest -m cuda -n4
          environment:
            PNL_LLVM_DEBUG: 'cuda'
            PYTHONWARNINGS: 'ignore::DeprecationWarning'

      - store_test_results:
          path: test-reports

      # upload coverage info
      - run:
          name: coveralls
          command: |
            . venv/bin/activate
            coveralls

      - store_artifacts:
          path: test-reports
#          destination: test-reports
